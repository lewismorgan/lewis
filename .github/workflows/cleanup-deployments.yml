name: Cleanup Deployments

on:
  schedule:
    # Runs weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      debug:
        description: 'List deletions only (no delete) when true'
        required: false
        default: 'true'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    name: Delete stale deployments
    env:
      DEBUG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug || 'false' }}
    steps:
      - name: Delete stale preview deployments (>14 days)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ENVIRONMENT: Preview
          DAYS_OLD: 14
        run: |
          set -e

          echo "Cleaning up $ENVIRONMENT deployments older than $DAYS_OLD days..."

          # Calculate cutoff date (14 days ago in ISO 8601 format)
          CUTOFF_DATE=$(date -u -d "$DAYS_OLD days ago" '+%Y-%m-%dT%H:%M:%SZ')
          echo "Cutoff date: $CUTOFF_DATE"

          # Fetch deployments for the environment
          DEPLOYMENTS_JSON=$(gh api repos/$REPO/deployments \
            --paginate \
            -f environment="$ENVIRONMENT" || true)

          if [ -z "$DEPLOYMENTS_JSON" ]; then
            echo "No deployments returned for $ENVIRONMENT."
            exit 0
          fi

          DEPLOYMENT_LIST=$(echo "$DEPLOYMENTS_JSON" | jq -r \
            --arg cutoff "$CUTOFF_DATE" \
            '.[] | select(.created_at < $cutoff) | [.id, .created_at, .ref, .sha, .environment, .url] | @tsv')

          DEPLOYMENTS=$(echo "$DEPLOYMENTS_JSON" | jq -r \
            --arg cutoff "$CUTOFF_DATE" \
            '.[] | select(.created_at < $cutoff) | .id')

          if [ -z "$DEPLOYMENTS" ]; then
            echo "No $ENVIRONMENT deployments older than $DAYS_OLD days found."
            exit 0
          fi

          if [ "$DEBUG" = "true" ]; then
            echo "Debug mode enabled. The following deployments would be deleted:"
            echo "id\tcreated_at\tref\tsha\tenvironment\turl"
            echo "$DEPLOYMENT_LIST"
            exit 0
          fi

          DELETED_COUNT=0
          while IFS= read -r DEPLOYMENT_ID; do
            if [ -z "$DEPLOYMENT_ID" ]; then
              continue
            fi
            
            echo "Deleting deployment: $DEPLOYMENT_ID"
            gh api repos/$REPO/deployments/$DEPLOYMENT_ID -X DELETE || {
              echo "Failed to delete deployment $DEPLOYMENT_ID"
              continue
            }
            ((DELETED_COUNT++))
          done <<< "$DEPLOYMENTS"

          echo "Deleted $DELETED_COUNT $ENVIRONMENT deployments"

      - name: Delete stale production deployments (>90 days)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ENVIRONMENT: Production
          DAYS_OLD: 90
        run: |
          set -e

          echo "Cleaning up $ENVIRONMENT deployments older than $DAYS_OLD days..."

          # Calculate cutoff date (90 days ago in ISO 8601 format)
          CUTOFF_DATE=$(date -u -d "$DAYS_OLD days ago" '+%Y-%m-%dT%H:%M:%SZ')
          echo "Cutoff date: $CUTOFF_DATE"

          # Fetch deployments for the environment
          DEPLOYMENTS_JSON=$(gh api repos/$REPO/deployments \
            --paginate \
            -f environment="$ENVIRONMENT" || true)

          if [ -z "$DEPLOYMENTS_JSON" ]; then
            echo "No deployments returned for $ENVIRONMENT."
            exit 0
          fi

          DEPLOYMENT_LIST=$(echo "$DEPLOYMENTS_JSON" | jq -r \
            --arg cutoff "$CUTOFF_DATE" \
            '.[] | select(.created_at < $cutoff) | [.id, .created_at, .ref, .sha, .environment, .url] | @tsv')

          DEPLOYMENTS=$(echo "$DEPLOYMENTS_JSON" | jq -r \
            --arg cutoff "$CUTOFF_DATE" \
            '.[] | select(.created_at < $cutoff) | .id')

          if [ -z "$DEPLOYMENTS" ]; then
            echo "No $ENVIRONMENT deployments older than $DAYS_OLD days found."
            exit 0
          fi

          if [ "$DEBUG" = "true" ]; then
            echo "Debug mode enabled. The following deployments would be deleted:"
            echo "id\tcreated_at\tref\tsha\tenvironment\turl"
            echo "$DEPLOYMENT_LIST"
            exit 0
          fi

          DELETED_COUNT=0
          while IFS= read -r DEPLOYMENT_ID; do
            if [ -z "$DEPLOYMENT_ID" ]; then
              continue
            fi
            
            echo "Deleting deployment: $DEPLOYMENT_ID"
            gh api repos/$REPO/deployments/$DEPLOYMENT_ID -X DELETE || {
              echo "Failed to delete deployment $DEPLOYMENT_ID"
              continue
            }
            ((DELETED_COUNT++))
          done <<< "$DEPLOYMENTS"

          echo "Deleted $DELETED_COUNT $ENVIRONMENT deployments"
